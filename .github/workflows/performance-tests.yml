name: Performance Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run performance tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  performance-tests:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
    
    - name: Build application
      run: npm run build
    
    - name: Run performance tests
      run: npm run test:perf
      env:
        CI: true
    
    - name: Upload performance report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-report
        path: test-results/
        retention-days: 7
    
    - name: Performance test results
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Performance Test Results
        path: test-results/performance-results.json
        reporter: 'json'
    
    - name: Comment performance results on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = './test-results/performance-results.json';
          
          if (fs.existsSync(path)) {
            const results = JSON.parse(fs.readFileSync(path, 'utf8'));
            const stats = results.stats || {};
            
            const comment = `## 📊 Performance Test Results
            
            - **Tests**: ${stats.expected || 0} passed, ${stats.unexpected || 0} failed, ${stats.skipped || 0} skipped
            - **Duration**: ${((stats.duration || 0) / 1000).toFixed(2)}s
            - **Status**: ${stats.unexpected > 0 ? '❌ Some tests failed' : '✅ All tests passed'}
            
            ${stats.unexpected > 0 ? 
              '⚠️  Some performance requirements were not met. Check the detailed report for optimization recommendations.' : 
              '🎉 All interactions meet the <100ms requirement!'
            }
            
            [View detailed performance report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }